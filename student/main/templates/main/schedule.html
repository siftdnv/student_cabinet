{% extends 'main/layout.html' %}
{% load static %}

{% block title %}–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ{% endblock %}

{% block content %}
<div class="dashboard-container">
    <aside class="sidebar">
        <div class="user-card">
            {% if user.studentprofile.avatar %}
                <img src="{{ user.studentprofile.avatar.url }}" alt="–ê–≤–∞—Ç–∞—Ä" class="avatar">
            {% else %}
                <img src="{% static 'main/img/student-avatar.jpg' %}" alt="–ê–≤–∞—Ç–∞—Ä" class="avatar">
            {% endif %}
            <h5>{{ user.first_name }} {{ user.last_name }}</h5>
            <p class="text-muted">–°—Ç—É–¥–µ–Ω—Ç ‚Ä¢
                {% if user.studentprofile.group %}
                    –ì—Ä—É–ø–ø–∞ {{ user.studentprofile.group }}
                {% else %}
                    –ì—Ä—É–ø–ø–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞
                {% endif %}
            </p>
            <div class="status-online">üü¢ –í —Å–µ—Ç–∏</div>
        </div>

        <ul class="nav-links">
            <li><a href="{% url 'dashboard' %}"><i class="fas fa-home"></i> –ì–ª–∞–≤–Ω–∞—è</a></li>
            <li><a href="{% url 'courses' %}"><i class="fas fa-book"></i> –£—á–µ–±–Ω—ã–µ –∫—É—Ä—Å—ã</a></li>
            <li><a href="{% url 'grades' %}"><i class="fas fa-chart-bar"></i> –£—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å</a></li>
            <li><a href="{% url 'schedule' %}" class="active"><i class="fas fa-calendar-alt"></i> –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</a></li>
            <li><a href="{% url 'tasks' %}"><i class="fas fa-tasks"></i> –ó–∞–¥–∞–Ω–∏—è</a></li>
            <li><a href="{% url 'record_book' %}"><i class="fas fa-file-invoice"></i> –ó–∞—á—ë—Ç–Ω–∞—è –∫–Ω–∏–∂–∫–∞</a></li>
        </ul>
    </aside>

    <main class="main-content">
        <div class="page-header">
            <div class="header-content">
                <div>
                    <h1><i class="fas fa-calendar-alt"></i> –ú–æ—ë —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h1>
                    <p class="text-muted">
                        –ì—Ä—É–ø–ø–∞: <strong>{{ group }}</strong> ‚Ä¢
                        –ù–µ–¥–µ–ª—è: <strong>{{ current_week }}</strong> ‚Ä¢
                        {% if schedule_data_loaded %}
                            <span class="text-success">‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {{ total_lessons }} –∑–∞–Ω—è—Ç–∏–π</span>
                        {% else %}
                            <span class="text-warning">‚ö†Ô∏è –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ</span>
                        {% endif %}
                    </p>
                    {% if last_update %}
                    <small class="text-muted">–û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ last_update|date:"d.m.Y H:i" }}</small>
                    {% endif %}
                </div>
                <div class="schedule-controls">
                    <button class="btn-control active">–ù–µ–¥–µ–ª—è</button>
                    <button class="btn-control">–ú–µ—Å—è—Ü</button>
                    <button class="btn-control">–°–µ–º–µ—Å—Ç—Ä</button>
                </div>
            </div>
        </div>

        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –µ—Å–ª–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ -->
        {% if not schedule_data_loaded %}
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            –†–µ–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.
            <a href="{% url 'update_schedule' %}" class="alert-link">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å</a> –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≥—Ä—É–ø–ø—ã.
        </div>
        {% endif %}

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è -->
        {% if schedule_data_loaded %}
        <div class="schedule-stats">
            <div class="stat-card">
                <i class="fas fa-book-open text-primary"></i>
                <div>
                    <h4>{{ total_lessons }}</h4>
                    <span>–í—Å–µ–≥–æ –∑–∞–Ω—è—Ç–∏–π</span>
                </div>
            </div>
            <div class="stat-card">
                <i class="fas fa-calendar-day text-success"></i>
                <div>
                    <h4>{{ days_with_lessons }}</h4>
                    <span>–î–Ω–µ–π —Å –∑–∞–Ω—è—Ç–∏—è–º–∏</span>
                </div>
            </div>
            <div class="stat-card">
                <i class="fas fa-sync-alt text-info"></i>
                <div>
                    <h4>{{ current_week }}</h4>
                    <span>–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è</span>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="current-lesson">
            <div class="current-info">
                <h3><i class="fas fa-play-circle"></i> –°–µ–π—á–∞—Å –∏–¥–µ—Ç:</h3>
                <div class="lesson-details" id="current-lesson-info">
                    <strong id="current-subject">–ü–∞—Ä –Ω–µ—Ç</strong>
                    <span id="current-time">–°–µ–π—á–∞—Å —É—á–µ–±–Ω—ã—Ö –∑–∞–Ω—è—Ç–∏–π –Ω–µ—Ç</span>
                    <span id="current-room"></span>
                    <span class="status-live" id="current-status">–ü–µ—Ä–µ—Ä—ã–≤</span>
                </div>
            </div>
            <div class="next-lesson">
                <strong>–°–ª–µ–¥—É—é—â–∞—è:</strong>
                <span id="next-lesson-info">–ü–∞—Ä –±–æ–ª—å—à–µ –Ω–µ—Ç —Å–µ–≥–æ–¥–Ω—è</span>
            </div>
        </div>

        <div class="schedule-week">
            {% for day_name in days_order %}
                {% with lessons=schedule|get_item:day_name %}
                {% if lessons %}
                <div class="day-column {% if day_name == current_day %}today{% endif %}">
                    <div class="day-header">
                        <h4>{{ day_name }}</h4>
                        <span class="day-date">{{ lessons|length }} –∑–∞–Ω—è—Ç–∏–π</span>
                    </div>
                    <div class="lessons-list">
                        {% for lesson in lessons %}
                        <div class="lesson-card" data-day="{{ day_name }}"
                             data-start="{{ lesson.time_start_str }}"
                             data-end="{{ lesson.time_end_str }}">
                            <div class="lesson-time">{{ lesson.time_start_str }} - {{ lesson.time_end_str }}</div>
                            <div class="lesson-subject">{{ lesson.subject }}</div>
                            <div class="lesson-details">
                                <span class="lesson-type {{ lesson.lesson_type|lower }}">{{ lesson.lesson_type }}</span>
                                <span class="lesson-room">{{ lesson.room }}</span>
                                {% if lesson.week_type %}
                                <span class="lesson-week-type {{ lesson.week_type|lower }}">{{ lesson.week_type }}</span>
                                {% endif %}
                            </div>
                            {% if lesson.teacher %}
                            <div class="lesson-teacher">
                                <i class="fas fa-user-tie"></i> {{ lesson.teacher }}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                {% endwith %}
            {% endfor %}
        </div>

        <div class="schedule-notes">
            <div class="notes-card">
                <h3><i class="fas fa-sync-alt"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º</h3>
                <ul class="notes-list">
                    <li>üîÑ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</li>
                    <li>‚è∞ –í—Ä–µ–º—è –¥–æ –∫–æ–Ω—Ü–∞ –ø–∞—Ä—ã —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</li>
                    <li>üìÖ –¢–µ–∫—É—â–∏–π –¥–µ–Ω—å –≤—ã–¥–µ–ª–µ–Ω –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏</li>
                    <li>üìä –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–Ω—è—Ç–∏–π</li>
                </ul>
                <div class="d-flex gap-2 mt-3">
                    <a href="{% url 'update_schedule' %}" class="btn btn-primary">
                        <i class="fas fa-sync"></i> –û–±–Ω–æ–≤–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–µ–π—á–∞—Å
                    </a>
                    <a href="{% url 'settings' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-cog"></i> –ò–∑–º–µ–Ω–∏—Ç—å –≥—Ä—É–ø–ø—É
                    </a>
                </div>
            </div>
        </div>
    </main>
</div>

<style>
.dashboard-container {
    display: grid;
    grid-template-columns: 280px 1fr;
    min-height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.sidebar {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    padding: 20px;
    box-shadow: 5px 0 25px rgba(0,0,0,0.1);
}

.user-card {
    text-align: center;
    padding: 20px 0;
    border-bottom: 1px solid #eee;
    margin-bottom: 20px;
}

.avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #4361ee;
    margin-bottom: 15px;
}

.nav-links {
    list-style: none;
    padding: 0;
}

.nav-links li {
    margin-bottom: 10px;
}

.nav-links a {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    text-decoration: none;
    color: #212529;
    border-radius: 10px;
    transition: all 0.3s ease;
}

.nav-links a:hover, .nav-links a.active {
    background: #4361ee;
    color: white;
    transform: translateX(5px);
}

.nav-links i {
    margin-right: 10px;
    width: 20px;
    text-align: center;
}

.main-content {
    padding: 30px;
}

.page-header {
    background: white;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.schedule-controls {
    display: flex;
    gap: 10px;
}

.btn-control {
    padding: 8px 16px;
    border: 2px solid #e9ecef;
    background: white;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-control.active,
.btn-control:hover {
    background: #4361ee;
    color: white;
    border-color: #4361ee;
}

.alert-warning {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
    color: #856404;
}

.alert-warning .alert-link {
    color: #856404;
    text-decoration: underline;
    font-weight: bold;
}

/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
.schedule-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 25px;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.stat-card i {
    font-size: 2rem;
    opacity: 0.8;
}

.stat-card h4 {
    margin: 0;
    font-size: 1.8rem;
    font-weight: bold;
    color: #4361ee;
}

.stat-card span {
    color: #6c757d;
    font-size: 0.9rem;
}

.current-lesson {
    background: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 25px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
    align-items: center;
}

.current-info h3 {
    color: #4361ee;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.lesson-details {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.status-live {
    color: #28a745;
    font-weight: bold;
}

.next-lesson {
    text-align: right;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
}

.schedule-week {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}

.day-column {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
}

.day-column.today {
    border: 2px solid #4361ee;
}

.day-header {
    background: linear-gradient(135deg, #4361ee, #3a0ca3);
    color: white;
    padding: 20px;
    text-align: center;
}

.day-header h4 {
    margin: 0 0 5px 0;
}

.day-date {
    opacity: 0.9;
    font-size: 0.9rem;
}

.lessons-list {
    padding: 15px;
}

.lesson-card {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 10px;
    border-left: 4px solid #6c757d;
    transition: all 0.3s ease;
}

.lesson-card:hover {
    transform: translateX(5px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.lesson-card.current {
    border-left-color: #28a745;
    background: #d4edda;
}

.lesson-card.upcoming {
    border-left-color: #17a2b8;
    background: #d1ecf1;
}

.lesson-time {
    font-weight: bold;
    color: #4361ee;
    margin-bottom: 5px;
}

.lesson-subject {
    font-weight: 600;
    margin-bottom: 8px;
    color: #212529;
}

.lesson-details {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
    flex-wrap: wrap;
}

.lesson-type, .lesson-room, .lesson-week-type {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    background: white;
    border: 1px solid #e9ecef;
}

.lesson-type.–ª–µ–∫—Ü–∏—è { background: #e7f3ff; border-color: #b3d9ff; }
.lesson-type.–ø—Ä–∞–∫—Ç–∏–∫–∞ { background: #fff0e6; border-color: #ffccb3; }
.lesson-type.–ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è { background: #e6f7e6; border-color: #b3e6b3; }

.lesson-week-type.—á–µ—Ç–Ω–∞—è { background: #fff0f0; border-color: #ffb3b3; }
.lesson-week-type.–Ω–µ—á–µ—Ç–Ω–∞—è { background: #f0f0ff; border-color: #b3b3ff; }

.lesson-teacher {
    color: #6c757d;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 5px;
}

.schedule-notes {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
}

.notes-card h3 {
    color: #4361ee;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.notes-list {
    list-style: none;
    padding: 0;
}

.notes-list li {
    padding: 10px 0;
    border-bottom: 1px solid #f0f0f0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.notes-list li:last-child {
    border-bottom: none;
}

.text-muted {
    color: #6c757d !important;
}

.status-online {
    color: #28a745;
    font-weight: bold;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .dashboard-container {
        grid-template-columns: 1fr;
    }

    .sidebar {
        display: none;
    }

    .header-content {
        flex-direction: column;
        gap: 15px;
    }

    .current-lesson {
        grid-template-columns: 1fr;
    }

    .schedule-stats {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    function updateCurrentLessonInfo() {
        const now = new Date();
        const currentDay = now.toLocaleDateString('ru-RU', { weekday: 'long' });
        const currentTime = now.getHours() * 60 + now.getMinutes();

        let currentLesson = null;
        let nextLesson = null;
        let foundCurrent = false;

        document.querySelectorAll('.lesson-card').forEach(card => {
            const day = card.dataset.day;
            const startTime = card.dataset.start;
            const endTime = card.dataset.end;

            if (day.toLowerCase() === currentDay.toLowerCase()) {
                const [startHour, startMinute] = startTime.split(':').map(Number);
                const [endHour, endMinute] = endTime.split(':').map(Number);

                const startTotal = startHour * 60 + startMinute;
                const endTotal = endHour * 60 + endMinute;

                if (currentTime >= startTotal && currentTime <= endTotal) {
                    currentLesson = card;
                    foundCurrent = true;

                    const subject = card.querySelector('.lesson-subject').textContent;
                    const room = card.querySelector('.lesson-room').textContent;
                    const remaining = endTotal - currentTime;

                    document.getElementById('current-subject').textContent = subject;
                    document.getElementById('current-time').textContent = `${startTime} - ${endTime}`;
                    document.getElementById('current-room').textContent = room;
                    document.getElementById('current-status').textContent = `–ò–¥–µ—Ç ‚Ä¢ –û—Å—Ç–∞–ª–æ—Å—å ${remaining} –º–∏–Ω`;
                    document.getElementById('current-status').style.color = '#28a745';

                } else if (!foundCurrent && currentTime < startTotal && !nextLesson) {
                    nextLesson = card;
                }
            }
        });

        if (!currentLesson) {
            document.getElementById('current-subject').textContent = '–ü–∞—Ä –Ω–µ—Ç';
            document.getElementById('current-time').textContent = '–°–µ–π—á–∞—Å —É—á–µ–±–Ω—ã—Ö –∑–∞–Ω—è—Ç–∏–π –Ω–µ—Ç';
            document.getElementById('current-room').textContent = '';
            document.getElementById('current-status').textContent = '–ü–µ—Ä–µ—Ä—ã–≤';
            document.getElementById('current-status').style.color = '#6c757d';
        }

        if (nextLesson) {
            const subject = nextLesson.querySelector('.lesson-subject').textContent;
            const time = nextLesson.querySelector('.lesson-time').textContent.split(' - ')[0];
            document.getElementById('next-lesson-info').textContent = `${subject} ‚Ä¢ ${time}`;
        } else {
            document.getElementById('next-lesson-info').textContent = '–ü–∞—Ä –±–æ–ª—å—à–µ –Ω–µ—Ç —Å–µ–≥–æ–¥–Ω—è';
        }

        updateLessonCardsHighlighting(currentTime, currentDay);
    }

    function updateLessonCardsHighlighting(currentTime, currentDay) {
        document.querySelectorAll('.lesson-card').forEach(card => {
            card.classList.remove('current', 'upcoming');

            const day = card.dataset.day;
            if (day.toLowerCase() === currentDay.toLowerCase()) {
                const startTime = card.dataset.start;
                const [startHour, startMinute] = startTime.split(':').map(Number);
                const startTotal = startHour * 60 + startMinute;
                const endTime = card.dataset.end;
                const [endHour, endMinute] = endTime.split(':').map(Number);
                const endTotal = endHour * 60 + endMinute;

                if (currentTime >= startTotal && currentTime <= endTotal) {
                    card.classList.add('current');
                } else if (currentTime < startTotal) {
                    card.classList.add('upcoming');
                }
            }
        });
    }

    updateCurrentLessonInfo();
    setInterval(updateCurrentLessonInfo, 60000);

    const lessonCards = document.querySelectorAll('.lesson-card');
    lessonCards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';

        setTimeout(() => {
            card.style.transition = 'all 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    document.querySelectorAll('.btn-control').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.btn-control').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });
});
</script>
{% endblock %}